<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>מערכת בקרת חניון</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
      :root {
        --yellow: #ffcc00;
        --green: #2ecc71;
        --red: #e74c3c;
        --dark: #2c3e50;
        --gray: #95a5a6;
      }
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        background: #f0f2f5;
        color: var(--dark);
        text-align: center;
      }

      /* אזור מצלמה */
      .preview-container {
        position: relative;
        width: 100vw;
        height: 30vh;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .scan-overlay {
        position: absolute;
        width: 260px;
        height: 80px;
        border: 4px solid var(--gray);
        border-radius: 12px;
        z-index: 5;
        transition: border-color 0.3s;
      }
      .scan-active {
        border-color: var(--yellow);
        box-shadow: 0 0 15px var(--yellow);
      }

      #floating-tag {
        position: absolute;
        top: -50px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 20px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 22px;
        display: none;
      }

      .main-panel {
        background: white;
        padding: 20px;
        border-radius: 25px 25px 0 0;
        margin-top: -20px;
        position: relative;
        z-index: 10;
        min-height: 70vh;
      }

      /* כפתור הפעלה מרכזי */
      .scan-toggle-btn {
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 12px;
        border: none;
        width: 100%;
        cursor: pointer;
        margin-bottom: 15px;
        transition: 0.3s;
      }
      .btn-off {
        background: var(--green);
        color: white;
      }
      .btn-on {
        background: var(--red);
        color: white;
      }

      #load-status-msg {
        display: none;
        padding: 12px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: bold;
      }
      .status-success {
        background: #d4edda;
        color: #155724;
      }
      .status-error {
        background: #f8d7da;
        color: #721c24;
      }

      .search-box {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin: 10px 0;
        text-align: center;
      }

      .db-container {
        margin-top: 15px;
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8em;
      }
      th,
      td {
        border: 1px solid #eee;
        padding: 8px;
        text-align: right;
      }
      th {
        background: var(--dark);
        color: white;
        position: sticky;
        top: 0;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <div class="preview-container">
      <video id="video" autoplay playsinline muted></video>
      <div id="overlay" class="scan-overlay"><div id="floating-tag"></div></div>
    </div>

    <div class="main-panel">
      <div
        id="ocr-status"
        style="font-size: 12px; color: #666; margin-bottom: 10px"
      >
        מנוע זיהוי כבוי
      </div>

      <button
        id="toggleBtn"
        class="scan-toggle-btn btn-off"
        onclick="toggleScanner()"
      >
        הפעל סריקה
      </button>

      <div
        id="result-display"
        style="
          display: none;
          padding: 15px;
          border-radius: 12px;
          border: 3px solid var(--green);
          margin-bottom: 15px;
          background: #d5f5e3;
        "
      ></div>

      <input
        type="text"
        id="manual-search"
        class="search-box"
        placeholder="בדיקה ידנית של מספר..."
        oninput="manualLookup()"
      />
    </div>

    <canvas id="canvas" style="display: none"></canvas>

    <script>
      let isScanningActive = false;
      let worker = null;

      async function initSystem() {
        fetchCSV(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyGHIa40xcrIAYQwPhb1rBWCjkxhWDE7dtfjymd4FXXkSOYJ7uYSff7_7WYAhqSXJKS9iyU_2xtoDZ/pub?output=csv",
        );

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          document.getElementById("video").srcObject = stream;
        } catch (e) {
          alert("יש לאשר גישה למצלמה");
        }
      }

      async function toggleScanner() {
        const btn = document.getElementById("toggleBtn");
        const overlay = document.getElementById("overlay");
        const status = document.getElementById("ocr-status");

        if (!isScanningActive) {
          // הפעלה
          isScanningActive = true;
          btn.innerText = "עצור סריקה";
          btn.className = "scan-toggle-btn btn-on";
          overlay.className = "scan-overlay scan-active";
          status.innerText = "מאתחל מנוע זיהוי...";

          if (!worker) {
            worker = await Tesseract.createWorker();
            await worker.loadLanguage("eng");
            await worker.initialize("eng");
            await worker.setParameters({
              tessedit_char_whitelist: "0123456789",
            });
          }
          status.innerText = "סורק פעיל...";
          runScan();
        } else {
          // עצירה
          isScanningActive = false;
          btn.innerText = "הפעל סריקה";
          btn.className = "scan-toggle-btn btn-off";
          overlay.className = "scan-overlay";
          status.innerText = "סורק כבוי";
          document.getElementById("floating-tag").style.display = "none";
        }
      }

      async function runScan() {
        if (!isScanningActive) return;

        const video = document.getElementById("video");
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = 260;
          canvas.height = 80;
          ctx.drawImage(
            video,
            (video.videoWidth - 260) / 2,
            (video.videoHeight - 80) / 2,
            260,
            80,
            0,
            0,
            260,
            80,
          );

          try {
            const {
              data: { text },
            } = await worker.recognize(canvas);
            const plate = text.replace(/\D/g, "");
            if (plate.length >= 7) checkVehicle(plate);
          } catch (e) {}
        }
        setTimeout(runScan, 500);
      }

      function checkVehicle(plate) {
        const cleanPlate = String(plate).replace(/\D/g, "");
        const group = getGroup(cleanPlate);

        const tag = document.getElementById("floating-tag");
        tag.innerText = plate;
        tag.style.display = "block";
        tag.style.backgroundColor = group ? "var(--green)" : "var(--red)";
        tag.style.color = "white";

        if (!group) return;

        const res = document.getElementById("result-display");
        res.style.display = "block";
        res.innerHTML = `<br>סוג: ${group}`;

        isScanningActive = false;

        setTimeout(() => {
          res.style.display = "none";
          tag.style.display = "none";

          if (document.getElementById("toggleBtn").innerText === "עצור סריקה") {
            isScanningActive = true;
            runScan();
          }
        }, 4000);
      }

      function manualLookup() {
        const val = document
          .getElementById("manual-search")
          .value.replace(/\D/g, "");
        if (val.length >= 7) checkVehicle(val);
      }

      let groupMap = new Map();

      async function fetchCSV(url) {
        try {
          const response = await fetch(url);
          const text = await response.text();
          buildMap(text);
        } catch (error) {
          console.error("Error fetching CSV:", error);
        }
      }

      function buildMap(csvText) {
        const rows = csvText.trim().split("\n");

        for (let i = 1; i < rows.length; i++) {
          const [num, group] = rows[i].split(",");
          groupMap.set(num.trim(), group.trim());
        }
      }

      function getGroup(num) {
        return groupMap.get(String(num)) || null;
      }

      window.onload = initSystem;
    </script>
  </body>
</html>
